<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Monitor Settings</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Water Level Monitor</h1>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/settings" class="active">Settings</a>
            </nav>
        </header>

        <!-- Warning Banner -->
        <div id="sensor-warning" class="alert warning" style="display:none;">
            ⚠️ No sensors detected – running in degraded mode.
        </div>

        <div class="card">
            <h2>System Settings</h2>
            <form id="settings-form">
                <div class="form-group">
                    <label for="sample_interval">Sample Interval (seconds)</label>
                    <input type="number" id="sample_interval" min="30" max="600" value="60">
                    <small>How often to read sensors (30-600 seconds)</small>
                </div>

                <div class="form-group">
                    <label for="leak_threshold">Leak Detection Threshold (%)</label>
                    <input type="number" id="leak_threshold" min="1" max="20" step="0.5" value="5">
                    <small>Difference between sensors that triggers leak detection (1-20%)</small>
                </div>

                <div class="form-group">
                    <label for="consecutive_readings">Consecutive Readings for Alert</label>
                    <input type="number" id="consecutive_readings" min="1" max="10" value="3">
                    <small>Number of consecutive leak readings before alert (1-10)</small>
                </div>

                <div class="form-group">
                    <label for="alert_cooldown">Alert Cooldown (seconds)</label>
                    <input type="number" id="alert_cooldown" min="300" max="7200" value="3600">
                    <small>Minimum time between alerts (300-7200 seconds)</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                    <button type="button" onclick="loadSettings()" class="btn">Reset</button>
                </div>
            </form>
        </div>

        <!-- Slack Notifications Card -->
        <div class="card">
            <h2>Slack Notifications</h2>
            <form id="slack-form">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="slack_enabled"> Enable Slack Notifications
                    </label>
                    <small>Send leak alerts and system notifications to Slack</small>
                </div>

                <div id="slack-settings" style="display:none;">
                    <div class="form-group">
                        <label for="slack_bot_token">Bot Token</label>
                        <input type="password" id="slack_bot_token" placeholder="xoxb-your-bot-token-here" autocomplete="off">
                        <small>Slack Bot User OAuth Token (starts with xoxb-)</small>
                        <button type="button" onclick="toggleTokenVisibility()" class="btn-small" style="margin-top: 5px;">Show/Hide</button>
                    </div>

                    <div class="form-group">
                        <label for="slack_channel">Channel</label>
                        <input type="text" id="slack_channel" placeholder="#water-alerts" value="#water-alerts">
                        <small>Slack channel to receive notifications (include #)</small>
                    </div>

                    <div class="form-group">
                        <label for="slack_mentions">Mentions</label>
                        <input type="text" id="slack_mentions" placeholder="@channel, @username" value="@channel">
                        <small>Users/groups to mention in urgent alerts (comma-separated)</small>
                    </div>

                    <div class="form-group">
                        <button type="button" onclick="testSlack()" class="btn">Test Slack Connection</button>
                        <div id="slack-test-result" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>Calibration Values</h2>
            <div class="calibration-info">
                <div class="calibration-values">
                    <h3>Reference Sensor</h3>
                    <p>Empty: <span id="ref-empty">--</span></p>
                    <p>Full: <span id="ref-full">--</span></p>
                </div>
                <div class="calibration-values">
                    <h3>Control Sensor</h3>
                    <p>Empty: <span id="ctrl-empty">--</span></p>
                    <p>Full: <span id="ctrl-full">--</span></p>
                </div>
            </div>
            <p class="info-text">
                To recalibrate sensors, use the calibration controls on the Dashboard page.
            </p>
        </div>

        <div class="card">
            <h2>System Status</h2>
            <div id="system-status">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadStatus();
            
            // Show/hide Slack settings based on checkbox
            document.getElementById('slack_enabled').addEventListener('change', function() {
                const slackSettings = document.getElementById('slack-settings');
                slackSettings.style.display = this.checked ? 'block' : 'none';
            });
        });

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    // Main settings
                    document.getElementById('sample_interval').value = data.sample_interval || 60;
                    document.getElementById('leak_threshold').value = data.leak_threshold || 5;
                    document.getElementById('consecutive_readings').value = data.consecutive_readings_for_alert || 3;
                    document.getElementById('alert_cooldown').value = data.alert_cooldown || 3600;
                    
                    // Slack settings
                    const slackConfig = data.slack || {};
                    document.getElementById('slack_enabled').checked = slackConfig.enabled || false;
                    document.getElementById('slack_bot_token').value = slackConfig.bot_token || '';
                    document.getElementById('slack_channel').value = slackConfig.channel || '#water-alerts';
                    
                    // Handle mention_users array
                    if (slackConfig.mention_users && Array.isArray(slackConfig.mention_users)) {
                        document.getElementById('slack_mentions').value = slackConfig.mention_users.join(', ');
                    } else {
                        document.getElementById('slack_mentions').value = '@channel';
                    }
                    
                    // Show/hide Slack settings
                    const slackSettings = document.getElementById('slack-settings');
                    slackSettings.style.display = slackConfig.enabled ? 'block' : 'none';
                    
                    // Calibration values
                    if (data.reference_sensor) {
                        document.getElementById('ref-empty').textContent = data.reference_sensor.calibration_empty;
                        document.getElementById('ref-full').textContent = data.reference_sensor.calibration_full;
                    }
                    if (data.control_sensor) {
                        document.getElementById('ctrl-empty').textContent = data.control_sensor.calibration_empty;
                        document.getElementById('ctrl-full').textContent = data.control_sensor.calibration_full;
                    }
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('system-status');
                    const slackStatus = data.slack_enabled ? '✅ Enabled' : '❌ Disabled';
                    
                    statusDiv.innerHTML = `
                        <p><strong>Monitoring:</strong> ${data.running ? '✅ Running' : '❌ Stopped'}</p>
                        <p><strong>Sensors:</strong> ${data.sensors_initialized ? '✅ Connected' : '❌ Failed'}</p>
                        <p><strong>Slack:</strong> ${slackStatus}</p>
                        <p><strong>Active Alerts:</strong> ${data.active_alerts || 0}</p>
                        <p><strong>Database Readings:</strong> ${data.statistics?.reading_count || 0}</p>
                        <p><strong>Latest Reading:</strong> ${data.latest_reading ? new Date(data.latest_reading.timestamp).toLocaleString() : 'None'}</p>
                    `;

                    // Toggle sensor warning
                    const warningBanner = document.getElementById('sensor-warning');
                    if (data.sensors_initialized === false) {
                        warningBanner.style.display = 'block';
                    } else {
                        warningBanner.style.display = 'none';
                    }
                })
                .catch(() => {
                    document.getElementById('system-status').innerHTML = '<p>Error loading status</p>';
                });
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('slack_bot_token');
            tokenInput.type = tokenInput.type === 'password' ? 'text' : 'password';
        }

        function testSlack() {
            const resultDiv = document.getElementById('slack-test-result');
            resultDiv.innerHTML = 'Testing Slack connection...';
            resultDiv.style.color = '#82aaff';
            
            fetch('/api/test-slack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '✅ Slack test message sent successfully!';
                    resultDiv.style.color = '#48c774';
                } else {
                    resultDiv.innerHTML = `❌ Slack test failed: ${data.error || 'Unknown error'}`;
                    resultDiv.style.color = '#ff6b6b';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `❌ Error testing Slack: ${error.message}`;
                resultDiv.style.color = '#ff6b6b';
            });
            
            // Clear message after 10 seconds
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 10000);
        }

        // Main settings form
        document.getElementById('settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const settings = {
                sample_interval: parseInt(document.getElementById('sample_interval').value),
                leak_threshold: parseFloat(document.getElementById('leak_threshold').value),
                consecutive_readings_for_alert: parseInt(document.getElementById('consecutive_readings').value),
                alert_cooldown: parseInt(document.getElementById('alert_cooldown').value)
            };
            
            saveSettings(settings, 'System settings saved successfully!');
        });

        // Slack settings form
        document.getElementById('slack-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Parse mentions into array
            const mentionsText = document.getElementById('slack_mentions').value.trim();
            const mentionsArray = mentionsText ? mentionsText.split(',').map(m => m.trim()) : ['@channel'];
            
            const slackSettings = {
                slack: {
                    enabled: document.getElementById('slack_enabled').checked,
                    bot_token: document.getElementById('slack_bot_token').value.trim(),
                    channel: document.getElementById('slack_channel').value.trim(),
                    mention_users: mentionsArray
                }
            };
            
            saveSettings(slackSettings, 'Slack settings saved successfully!');
        });

        function saveSettings(settings, successMessage) {
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(successMessage);
                    loadStatus();
                } else {
                    alert('Error saving settings: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error saving settings: ' + error.message);
            });
        }
    </script>
</body>
</html>
